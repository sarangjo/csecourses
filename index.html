<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>UW CSE Courses</title>
        <script type="text/javascript" src="d3/d3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <script type="text/javascript">
            var w = 640;
            var h = 480;

            // How many levels of classes we're considering
            // 3 means 1xx 2xx and 3xx levels
            var LEVELS = 3;

            var filenames = ["csecourses/testcourses.json", "csecourses/testlinks.json"];

            loadFiles(filenames);

            /**
             * Loads the given list of file names. Calls onFilesLoaded when files are 
             * done loading.
             */
            function loadFiles(filenames) {
                var q = queue();

                filenames.forEach(function(d) {
                    q.defer(d3.json, d);
                });
                q.awaitAll(onFilesLoaded);
            }

            /**
             * Called when the JSON files have been loaded.
             */
            function onFilesLoaded(err, results) {
                var nodes = results[0];
                // Sort by course number
                nodes.sort(function(a, b) {
                    return a.number - b.number;
                });

                console.log("Sorted");

                var links = results[1];

                setPositions(nodes);

                var svg = d3.select("body").append("svg")
                    .attr("width", w)
                    .attr("height", h);

                /*svg.append("defs").selectAll("marker")
                    .data(["suit", "licensing", "resolved"])
                    .enter().append("marker")
                        .attr("id", function(d) { return d; })
                        .attr("viewBox", "0 -5 10 10")
                        .attr("refX", 25)
                        .attr("refY", 0)
                        .attr("markerWidth", 6)
                        .attr("markerHeight", 6)
                        .attr("orient", "auto")
                    .append("path")
                        .attr("d", "M0,-5L10,0L0,5 L10,0 L0, -5")
                        .style("stroke", "#4679BD")
                        .style("opacity", "0.6");*/

                var force = d3.layout.force()
                    .size([w, h])
                    .nodes(nodes)
                    .links(links);

                // Attaching nodes and links to the visualization
                var link = svg.selectAll(".link")
                    .data(links).enter()
                    .append("line")
                    .attr("class", "link")
                    .style("marker-end", "url(#suit)");

                var node = svg.selectAll(".node")
                    .data(nodes).enter()
                    .append("circle")
                    .attr("class", "node");

                force.on('end', function() {
                    node.attr('r', w/30)
                        .attr('cx', function(d) { return d.x; })
                        .attr('cy', function(d) { return d.y; });
                
                    link.attr('x1', function(d) { return d.source.x; })
                        .attr('y1', function(d) { return d.source.y; })
                        .attr('x2', function(d) { return d.target.x; })
                        .attr('y2', function(d) { return d.target.y; });

                    console.log("Done!");
                });

                force.start();
            }

            /**
             * Sets the positions of the given nodes.
             */
            function setPositions(nodes) {
                var BASE_X = 60;
                var xCounter = 0;
                var currentLevel = 1;
                var size = 50;

                nodes.forEach(function(n) {
                    var level = Math.floor(n.number / 100);
                    n.y = level * size;

                    if (level != currentLevel) {
                        currentLevel = level;
                        xCounter = 0;
                    }

                    n.x = BASE_X + (xCounter * size);
                    xCounter++;
                });

                // Doesn't allow force to actually modify the positions of the nodes
                nodes.forEach(function(n) {
                    n.fixed = true;
                });

                console.log(nodes);
            }
        </script>
        <p>Hello World!</p>
    </body>
</html>