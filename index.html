<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>UW CSE Courses</title>
        <script type="text/javascript" src="d3/d3.min.js"></script>
        <script type="text/javascript" src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <script type="text/javascript">
            var w = 2400;
            var h = 480;

            // How many levels of classes we're considering
            var LEVELS = 3;

            var filenames = ["csecourses/testcourses"+ LEVELS + ".json", "csecourses/testlinks"+ LEVELS + ".json"];

            loadFiles(filenames);

            /**
             * Loads the given list of file names. Calls onFilesLoaded when files are 
             * done loading.
             */
            function loadFiles(filenames) {
                var q = queue();

                filenames.forEach(function(d) {
                    q.defer(d3.json, d);
                });
                q.awaitAll(onFilesLoaded, true);
            }

            /**
             * Called when the JSON files have been loaded.
             */
            function onFilesLoaded(err, results, fixed) {
                var nodes = results[0];
                var links = results[1];

                setupNodes(nodes);

                var svg = d3.select("body").append("svg")
                    .attr("width", w)
                    .attr("height", h);

                svg.append("defs").selectAll("marker")
                        .data(["regular"])
                        .enter().append("marker")
                        .attr("id", function(d) { return d; })
                        .attr("viewBox", "0 -5 10 10")
                        .attr("refX", 25)
                        .attr("refY", 0)
                        .attr("markerWidth", 6)
                        .attr("markerHeight", 6)
                        .attr("orient", "auto")
                    .append("path")
                        .attr("d", "M0,-5L10,0L0,5 L10,0 L0, -5")
                        .style("stroke", "#4679BD")
                        .style("opacity", "0.6");

                // Main part of force layout
                var force = d3.layout.force()
                    .size([w, h])
                    .nodes(nodes)
                    .links(links);

                // Attaching nodes and links to the visualization
                var link = svg.selectAll(".link")
                    .data(force.links()).enter()
                    .append("line")
                    .attr("class", "link")
                    // Attaches marker (arrow) to the end of the link
                    // As of now the regular link is just called "regular"
                    .style("marker-end", "url(#regular)");

                var node = svg.selectAll(".node")
                    .data(force.nodes()).enter()
                    .append("circle")
                    .attr("class", "node");

                var text = svg.selectAll(".text")
                    .data(force.nodes()).enter()
                    .append("text")
                    .text(function(d) { return d.number; });

                force.on('end', function() {
                    node.attr('r', 20)
                        .attr('cx', function(d) { return d.x; })
                        .attr('cy', function(d) { return d.y; });
                
                    link.attr('x1', function(d) { return d.source.x; })
                        .attr('y1', function(d) { return d.source.y; })
                        .attr('x2', function(d) { return d.target.x; })
                        .attr('y2', function(d) { return d.target.y; });

                    text.attr("x", function(d) { return d.x - 12; })
                        .attr("y", function(d) { return d.y + 5; });
                    

                    console.log("Done!");

                    d3.select("body").append("p").text("Done Loading!");
                });

                force.start();
            }

            ///////////// HELPER METHODS /////////////

            /**
             * Sorts and sets nodes' positions.
             */
            function setupNodes(nodes) {
                // Sort by course number
                nodes.sort(function(a, b) {
                    return a.number - b.number;
                });

                // Sets the positions of the given nodes
                var BASE_X = 60;
                var LEVEL_OFFSET = 150;
                var NODE_SIZE = 50;
                
                var currentLevel = 1;
                var xCounter = 0;
                var yShift = false;

                nodes.forEach(function(n) {
                    var level = Math.floor(n.number / 100);
                    level = (level != 1 ? level - 2 : level - 1);
                    
                    // Updates level
                    if (level != currentLevel) {
                        currentLevel = level;
                        xCounter = 0;
                    }

                    n.x = BASE_X + (xCounter * NODE_SIZE);
                    n.y = (LEVEL_OFFSET / 2) + (level * LEVEL_OFFSET) + (yShift ? 30 : 0);
                    // Doesn't allow force to actually modify the positions of the nodes
                    n.fixed = true;
                    
                    xCounter++;
                    yShift = !yShift;
                });

                console.log(nodes);
            }
        </script>
        <p>Welcome to UW CSE Courses!</p>
    </body>
</html>